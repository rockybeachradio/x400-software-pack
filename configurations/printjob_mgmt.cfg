################################################################################################
# File: printing_mgmt.cfg
# Author: Eryone / Modified by Andreas
# Date: 202500818
# purpose: Print job management (start, paus, end, powerloss)
#
# To Check why not configrued:
# - _TOOLHEAD_PARK_PAUSE_CANCEL   # Mainsail Macros: https://docs.mainsail.xyz/setup/configuration
#
# include in printer.cfg
################################################################################################


################################################################################################
# Basic function
################################################################################################
[idle_timeout]    # Klipper safety and energy-saving mechanism.
timeout: 120      # Wait 120 seconds
gcode:
  {% if printer.pause_resume.is_paused == True  %}   
    M104 S0       # Turns off the Hotend heater: S0 = 0°C
  {% else %}
    M104 S0
    M84         # Turns off all stepper motors (energysafing)
    SET_PIN PIN=Board_FAN VALUE=0.0   # turnsoff the Board_fan
  {% endif %}


################################################################################################
# Object detection
################################################################################################
[gcode_shell_command DETECT_BED_OBJECT]         # Calls the python3 "/home/mks/mainsail/all/cv.py 32" .Creae a gcode accessible shell command which can be called from a Macro.
command: /home/mks/mainsail/all/bed_object.sh   # executes the shell script bed_object.sh
timeout:8                                       # Maximum tine Klipper will wait for the script to complete before aborting. (in seconds)
    # bed_object.sh
    #   calls cv.py with the argument 32    --> the variabl 32 is unused
    # cv.py
    #   This Python script is a basic computer vision tool for Klipper 3D printers with a webcam, designed to:
    #   Detect if an object is on the bed (but NOT a blob, spaghetti, failed print)
    # If detected, it:
    #    Displays a message (M117) on the printer
    #    Sends a PAUSE command to stop the print



################################################################################################
# Z-Probe - Probe handling
################################################################################################
[output_pin reset_probe]        # Z-Probe: Configure the digital output pin
pin:EECAN:gpio0                 # Define the PIN
pwm:False                       # Disable PWM (pulse width modulation). This means the pin operates in binary (on/off) mode.
value:1                         # Set the default state of the pin, when klipper starts to HIGH (1)

##############################################################
[gcode_macro resetON]                       # ???
gcode:  SET_PIN PIN=reset_probe VALUE=1     # Set the reset_prove to the logic level HIGH

##############################################################
[gcode_macro resetOFF]                      # ???
gcode:  SET_PIN PIN=reset_probe VALUE=0     # Set the reset_probe to the logic level LOW (0V)

##############################################################
[gcode_macro RS_probe]          #
gcode:
    M400                        # Wait for all current moves to finish (flusehs he planner queue)
    ;reset_probe_adc            # Calls the macro reset_probe_adc
    ;G4 P0                      # Wait 0ms
    ;{ action_respond_info("RS_probe") }    # Feedback Message to Mainsail console
    resetON                     # set the GPIO pin to HIGH (1)
    G4 P100                     # Wait 100ms
    resetOFF                    # set the GPIO pin to LOW (0)
    G4 P200                     # s.o.
    resetON                     # s.o.
    G4 P100                     # s.o.


##############################################################
[output_pin rt_probe_adc]       # Z-Probe:
pin:EECAN:gpio2                 # Define the PIN
pwm:False                       # Disable PWM (pulse width modulation). This means the pin operates in binary (on/off) mode.
value:1                         # Set the default state of the pin, when klipper starts to HIGH (1)

##############################################################
[gcode_macro reset_probe_adc]               # Reset or calibrate the analog-to-digital converter (ADC) signal used by a resistive probe. eg. Z-probe
gcode: 
     SET_PIN PIN=rt_probe_adc VALUE=1       # Set the pin rt_probe_abc to HIGH (1)
     G4 P100                                # Waits 100ms
     SET_PIN PIN=rt_probe_adc VALUE=0       # Set the pin rt_probe_abc to LOW (0)
     G4 P500                                # Pause for 500ms
     SET_PIN PIN=rt_probe_adc VALUE=1       # s.o.
     G4 P200                                # Pause for 200ms



################################################################################################
# Printing
################################################################################################

##############################################################
# [gcode_macro CANCEL_PRINT]    # Is defined in ~/mainsail-config/client.cfg
# [BED_MESH_CALIBRATE]          # Replaced by KAMP_Settings.cfg --> Adaptive_meshing.cfg

##############################################################
[gcode_macro PRINT_START]                                       # Runs at the beginning of a print job. Includes logic for AI-based object detection
gcode:
    # SET_FAN_SPEED FAN=filter_fan SPEED=0.9                      # set fan to 90% speed    # deactivated by Andreas
    {% if printer.save_variables.variables.use_ai==True %}      # If AI is activated
        ;{% if 'xy' not in printer.toolhead.homed_axes %}
            G28 X Y                                             # home X and Y
        ;{% endif %}
        G90                                                     # set absolute mode
        ;G1 X399 Y399
        SET_PIN PIN=LED VALUE=1                         # Turns on the LED to 100%
        M18                                             # Diable all stepper motors. Printer stays still during detection (no jitter and power draw)
        M117 Detecting object on the Bed with Camera    # Display message on Screen
        RUN_SHELL_COMMAND CMD=DETECT_BED_OBJECT         # Calls she shell command detect_bed_object
        G4 P8000                                        # pauses for 8000ms (8sec) to allow the detection script run
        SET_PIN PIN=LED VALUE=0.1                       # Set LED grightness to 10%
        M117 .                                          # Display message on Screen
    {% endif %}

##############################################################
[gcode_macro PRINT_END]                                 # Cleanup routine after a print finished
gcode:
    # Turn off bed, extruder, and fan
    M140 S0                                             # Turn off heated bed
    M104 S0                                             # Turn off extruder
    M106 S0                                             # Turn off print cooling fan
    SAVE_VARIABLE VARIABLE=filename VALUE=".gc"         # saves teh variable to the variable-file.
    SET_FAN_SPEED FAN=filter_fan SPEED=0                # Turn off chamber fan ???
    # Move nozzle away from print while retracting
    G91                                                 # Switch to relative mode
    G1 E-2.6 F300                                       # Retract 2,6mm filament
    G1 X-1 Y-1 F600                                     # Move toolhead/nozzle X = 1mm and Y 1mm. prevents oozing and clears the nottle from the print.
    G1 Z2 F3000                                         # Rise toolhead up by 2mm
    G90                                                 # Switch to absolute mode
    G1 X399 Y399                                        # Move toolhead to the corner of the printer bed
    M84                                                 # Disable steppers
    SET_PIN PIN=Board_FAN VALUE=0.0                     # Turn off the board fan
    TURN_OFF_HEATERS
    M117 .                                              # Disply message on the screen

##############################################################
[gcode_macro  INTRO_LINE]       # Prints intro Line of a filament before acctual print starts - to prime the nozzle and ensure consistent extrusion
description: the intro line before printing
gcode:  
    # Handle the nozzle diameter (optinal param)
    {% set diameter_n = 0.4 %}                                      # Defines a default diameter_n withg the calue 0.4mm
    {% if params.D %}                                               # Checks wether the macro was walled with a parameter D. (eg. INTRO_LINE D=0.6)
	    { action_respond_info("nozzle diameter %s "%params.D) }     # Display the diameter on the UI
	    {% set diameter_n = params.D|default(0.4)|float %}          # Set the diameter_n to the value handed over.
	{% endif %}
    {% if diameter_n == 0.4 %}      # If the nozzle is 0.4mm, the following code will be executed
        G92 E0.0                    # Reset the extruder position to zero (E=0)
        ; intro line                
        G1 X210.0 E10 F1000         # Moves the toolhead to X=210 and extrudes 10mm of filament. The feedrate is set to 1000mm/min (=16.7mm/s)
        G1 Y0.6                     # Nudge slightly upward to clean up the line, avoiding blobs
        G1 X250.0 E5 F1000          # s.o.
        G92 E0.0                    # s.o.
        M117 .                      # Shows message on LCD
    {% endif %}




################################################################################################
# Power-Loss Recovery
#################################################################################################
# AT24cxx Module (EEPROM with serial port I2C) needs to be connected to the "reserved serial port / USART3" on the SKIPR Board.
# some more files:
#   /printer_data/config/plr.sh
#   /printer_data/config/plr.cfg
#
# Slicer settings (Orca slicer):
#     Printer settings --> Machine G-code --> Machine start G-code: Add: RESUME_ENABLE
#     Printer settings --> Machine G-code -->Before layer change G-code: Add: LOG_Z H=[layer_z] L=[layer_height]
#
# !!! [at24c_eeprom] is not defined !!!
#
##############################################################
[gcode_shell_command POWER_LOSS_RESUME]         # This runs a custom shell script (plr.sh) with parameters:
command: /home/mks/printer_data/config/plr.sh   # Runs the sh script.
timeout: 50                                     # Klipper waits for 5 seconds for the shell scriopt (plr.sh) to finish running.


[gcode_shell_command DATA_SYNC]                 # ??? Where is it called?
command: sync                                   # Write any data that’s still in RAM out to the storage device right now.
                                                # sync forces that flushing process so that:
                                                #   - All file system buffers are written to disk
                                                #   - All metadata changes are committed
                                                #   - The system's in-memory view of files matches the on-disk state
                                                # Why you might use it:
                                                #   - Before removing a USB drive or SD card to avoid data loss
                                                #   - After a script that modifies critical files, to ensure they're really saved#
                                                #   - Before running power-off commands on systems where you can't trust automatic flushing
timeout: 50

##############################################################
[gcode_macro PRINT_CONTINUE]                    # ??? How to call it?
description: 
gcode:
    {% set z_pos = params.Z|default('1.4')|string %}                                                                # Looks for a macro parameter named Z. If nit there set z_pos = 1.4.
    { action_respond_info("z_pos %s "%z_pos) }                                                                      # Klipper macro debug message
    #{ action_respond_info("file_path %s "%printer.configfile.settings.virtual_sdcard.path ) }

    {% set file = params.FILE|default(printer.save_variables.variables.filename)|replace("'", "")|string %}         # Looks for a macro parameter named FILE and removes " ' "
    {% set file = file|replace("%20", " ")|string %}                                                                # replaces %20 with space
    {% set file_path =  "'"+printer.configfile.settings.virtual_sdcard.path +'/' + file +"'"  %}                    # creates variable
    { action_respond_info("file_path %s "%file_path) }                                                              # s.o.
    RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME PARAMS="{z_pos} {file_path}"                                            # Calls shell_command Power_loss_resume with parameters
    SDCARD_PRINT_FILE FILENAME="{file}" Z=1                                                                         # Starts the print-process with the file stored on the virtual_sdcard
                                                                                                                    # sdcard_print_file does not support paramaeter. Z=1 will be ignored. Or ist there a spezial Eryone version?





################################################################################################
# Cleaning the Nozzle.
#
# Heating the Nozzle, Purging, Wiping, Cooling
################################################################################################
[gcode_macro CLEAN_N]
gcode:
    # this is for different diameter
    {% set diameter_n = 0.4 %}
      {% if params.D %}
	    { action_respond_info("nozzle diameter %s "%params.D) }
	    {% set diameter_n = params.D|default(0.4)|float %}
	  {% endif %}
	# heating the nozle
    SET_PIN PIN=Board_FAN VALUE=0.80
	{% if params.S %}
        M117 Heating
	    { action_respond_info("Heating extruder to %s C"%params.S) }
	    M109 S{params.S}
	{% endif %}
		
    #homing  
    ;{% if 'xy' not in printer.toolhead.homed_axes %}
    ;   SET_KINEMATIC_POSITION Z=1
    ;   G1 Z3
    G28 X Y
    ;{% endif %}
    ;SET_KINEMATIC_POSITION Z={printer.toolhead.axis_maximum.z|default(100)|float-5}
    G90
    G1 X398 Y3  F6000

    # Postioning logic
    {% if params.Y and params.Y|float <= params.A|float %}
       G1 X{params.X|default('240')} Y{params.A} F6000
       ; { action_respond_info("y %s  "%(params.A)) }
    {% elif params.Y and params.Y|float >= (printer.toolhead.axis_maximum.y|default(100)|float - params.A|float) %}
       G1 X{params.X|default('240')} Y{printer.toolhead.axis_maximum.y|default(100)|float - params.A|float} F6000
       ;{ action_respond_info("yy %s  "%(printer.toolhead.axis_maximum.y|default(100)|float - params.A|float)) }
    {% else %}
	  G1 X{params.X|default('240')} Y{params.Y|default('0')} F6000  
       ;{ action_respond_info("yyy %s  "%(params.Y)) }
    {% endif %}
    G1 X{params.X|default('240')} F6000
    
    # home nozzle (Z only)
    G28 N
    
    # adjust Y position
    M117 Cleaning nozzle 
	;SET_KINEMATIC_POSITION X=240
	{% if params.Y and params.Y|float < 0 %} # Y < 0
	    G1 Y0 F6000	    
	    SET_KINEMATIC_POSITION Y={0.905-params.Y|default('0')|int}
	    G1 Y0.905 F6000
	{% elif params.Y and params.Y|float > (printer.toolhead.axis_maximum.y|default(100)|float - 3) %} # Y >max
	    G1 Y{params.Y|default('0')} F6000
	    SET_KINEMATIC_POSITION Y=0.905
	{% else %} #
	    G1 Y{params.Y|default('0')} F6000
	    SET_KINEMATIC_POSITION Y=0.905
	{% endif %}
    ##
    RS_probe
    probe PROBE_SPEED=2
    SET_KINEMATIC_POSITION Z=0
	G1 Z1
    G1 X242
	G92 E0.0
	## line move
	G90
	G1 Z.2 G1 E3
	M83
    G1 E3
	G92 E0.0
    G1 X280.0 E3.0 F600
	G1 X265.0 Y3 E3.0  
	G1 X250.0 Y0.2 E1.0  
    G1 X280.0 E1.0  
	G1 X265.0 Y3 E2.0  
	G1 X259.0 Y0.2 E2.0 
    G1 X280.0 Y0 E3.0  
    G1 Z2
    G92 E0.0
    G1 Y8 F6000
    G1 X237  F6000
    G1 X237 Y2
    G1 Z.2
    
	## infill move
	;G1 X208.978 Y18.134 E.6 F6000
	;G1 E.6 F1800
  ;  G1 F900  
  ; G1 Y.905
    ;M104 S150
  ; G1 X280 E8
  ; G1 Y1.905
  ; G1 X239.265 E8
	G1 F1350
    ;M104 S150

   G1 X237.121 Y.309 E2
   G1 X236.585 Y.309 E.01654
   G1 X238.968 Y3.3 E.10405
   G1 X238.433 Y3.3 E.01654
   G1 X236.05 Y.309 E.10405
   G1 X235.514 Y.309 E.01654
   G1 X237.897 Y3.3 E.10405
   G1 X237.361 Y3.3 E.01654
   G1 X234.978 Y.309 E.10405
   G1 X234.442 Y.309 E.01654
   G1 X236.825 Y3.3 E.10405
   G1 X236.289 Y3.3 E.01654
   G1 X233.906 Y.309 E.10405
   G1 X233.37 Y.309 E.01654
   G1 X235.753 Y3.3 E.10405
   G1 X235.217 Y3.3 E.01654
   G1 X232.835 Y.309 E.10405
   G1 X232.299 Y.309 E.01654
   G1 X234.682 Y3.3 E.10405
   G1 X234.146 Y3.3 E.01654
   G1 X231.763 Y.309 E.10405
   G1 X231.227 Y.309 E.01654
   G1 X233.61 Y3.3 E.10405
   G1 X233.074 Y3.3 E.01654
   G1 X230.691 Y.309 E.10405
   G1 X230.155 Y.309 E.01654
   G1 X232.538 Y3.3 E.10405
   G1 X232.002 Y3.3 E.01654
   G1 X229.62 Y.309 E.10405
   G1 X229.084 Y.309 E.01654
   G1 X231.467 Y3.3 E.10405
   G1 X230.931 Y3.3 E.01654
   G1 X228.548 Y.309 E0.1
   G1 X228.012 Y.309 E.01654
   G1 X230.395 Y3.3 E.10405
   G1 X229.859 Y3.3 E.01654
   G1 X227.476 Y.309 E.10405
   G1 X226.94 Y.309 E.01654
   G1 X229.323 Y3.3 E.10405
   G1 X228.787 Y3.3 E.01654
   G1 X226.404 Y.309 E.10405
   G1 X225.869 Y.309 E.01654
   G1 X228.252 Y3.3 E.10405
   G1 X227.716 Y3.3 E.01654
   G1 X225.333 Y.309 E.10405
   G1 X224.797 Y.309 E.01654
   G1 X227.18 Y3.3 E.10405
   G1 X226.644 Y3.3 E.01654
   G1 X224.261 Y.309 E0.1
   G1 X223.725 Y.309 E.01654
   G1 X226.108 Y3.3 E.10405
   G1 X225.572 Y3.3 E.01654
   G1 X223.189 Y.309 E.10405
   G1 X222.654 Y.309 E.01654
   G1 X225.036 Y3.3 E.10405
   G1 X224.501 Y3.3 E.01654
   G1 X222.118 Y.309 E.10405
   G1 X221.582 Y.309 E.01654
   G1 X223.965 Y3.3 E.10405
   G1 X223.429 Y3.3 E.01654
   G1 X221.046 Y.309 E.10405
   G1 X220.51 Y.309 E.01654
   G1 X222.893 Y3.3 E.10405
   G1 X222.357 Y3.3 E.01654
   G1 X219.974 Y.309 E.10405
   G1 X219.438 Y.309 E.01654
   G1 X221.821 Y3.3 E.10405
   G1 X221.286 Y3.3 E.01654
   G1 X218.903 Y.309 E.10405
   G1 X218.367 Y.309 E.01654
   G1 X220.75 Y3.3 E.10405
   G1 X220.214 Y3.3 E.01654
   G1 X217.831 Y.309 E.10405
   G1 X217.295 Y.309 E.01654
   G1 X219.678 Y3.3 E.10405
   G1 X219.142 Y3.3 E.01654
   G1 X216.759 Y.309 E.10405
   G1 X216.223 Y.309 E.01654
   G1 X218.606 Y3.3 E.10405
   G1 X218.07 Y3.3 E.01654
   G1 X215.688 Y.309 E.10405
   G1 X215.152 Y.309 E.01654
   G1 X217.535 Y3.3 E.10405
   G1 X216.999 Y3.3 E.01654
   G1 X214.616 Y.309 E.10405
   G1 X214.08 Y.309 E.01654
   G1 X216.463 Y3.3 E.10405
   G1 X215.927 Y3.3 E.01654
   G1 X213.544 Y.309 E.10405
   G1 X213.008 Y.309 E.01654
   G1 X215.391 Y3.3 E.10405
   G1 X214.855 Y3.3 E.01654
   G1 X212.472 Y.309 E.10405
   G1 X211.937 Y.309 E.01654
   G1 X214.32 Y3.3 E.10405
   G1 X213.784 Y3.3 E.01654
   G1 X211.401 Y.309 E.10405
   G1 X210.865 Y.309 E.01654
   G1 X213.248 Y3.3 E.10405
   G1 X212.712 Y3.3 E.01654
   G1 X210.329 Y.309 E.10405
   G1 X211.22 Y.309 E0.3
   G1 X213.603 Y3.3 E.1
   G1 X213.067 Y3.3 E.02
   G1 X210.684 Y.309 E.1
   G1 X210.148 Y.309 E.02
   G1 X212.531 Y3.3 E.1
   G1 X211.995 Y3.3 E.02
   G1 X209.612 Y.309 E.1
   G1 X209.076 Y.309 E.02
   G1 X211.459 Y3.3 E.1
   G1 X210.923 Y3.3 E.02
   G1 X208.541 Y.309 E.1
   G1 X208.005 Y.309 E.02
   G1 X210.388 Y3.3 E.1
   G1 X209.852 Y3.3 E.02
   G1 X207.469 Y.309 E.1
   G1 X206.933 Y.309 E.02
   G1 X209.316 Y3.3 E.1
   G1 X208.78 Y3.3 E.02
   G1 X206.397 Y.309 E.1
   G1 X205.861 Y.309 E.02
   G1 X208.244 Y3.3 E.1
   G1 X207.708 Y3.3 E.02
   G1 X205.325 Y.309 E.1
   G1 X204.79 Y.309 E.02
   G1 X207.173 Y3.3 E.1
   G1 X206.637 Y3.3 E.02
   G1 X204.254 Y.309 E.1
   G1 X203.718 Y.309 E.02
   G1 X206.101 Y3.3 E.1
   G1 X205.565 Y3.3 E.02
   
   ## cool nozzle
    G1 X186.752 Y.309
   
    G1 Z-0.2
    M117 cooling nozzle   
    #M106 S230
    M109 S140
    G1 Z1
    G1 X179.25 Y3
	RS_probe
    probe PROBE_SPEED=2
    SET_KINEMATIC_POSITION Z=0
    M106 S0
 
   G1 X178.714 Y.309
   G1 X181.097 Y2.691 
   G1 X180.561 Y2.691 
   G1 X178.178 Y.309 
   G1 X177.643 Y.309 
   G1 X180.026 Y2.691 
   G1 X179.49 Y2.691 
   G1 X177.107 Y.309 
   G1 X176.571 Y.309 
   G1 X178.954 Y2.691 
   G1 X178.418 Y2.691 
   G1 X176.035 Y.309 
   G1 X175.499 Y.309 
   G1 X177.882 Y2.691 
   G1 X177.346 Y2.691 
   G1 X174.963 Y.309 
   G1 X174.428 Y.309 
   G1 X176.81 Y2.691 
   G1 X176.275 Y2.691 
   G1 X173.892 Y.309 
   G1 X173.356 Y.309 
   G1 X175.739 Y2.691 
   G1 X175.203 Y2.691 
   G1 X172.82 Y.309 
   G1 X172.284 Y.309 
   G1 X174.667 Y2.691 
   G1 X174.131 Y2.691 
   G1 X171.748 Y.309 
   G1 X171.213 Y.309 
   G1 X173.595 Y2.691 
   G1 X173.06 Y2.691 
   G1 X170.677 Y.309 
   G1 X170.141 Y.309 
   G1 X172.524 Y2.691 
   G1 X171.988 Y2.691 
   G1 X169.605 Y.309  

	## waiting cool
	M106 S0
	## move more close to bed
    ;M104 S150
    ;M109 S150
	#G1 Z0.06

    ## must homing XY
    G1 Z10
    G28 

    M117 .
    #G1 X300 Y300
	G92 E0.0


